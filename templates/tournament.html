{% extends "base.html" %}
{% block title %}Tournament — {{ patient.id }}{% endblock %}

{% block head %}
<style>
/* ── Page stack ─────────────────────────────────────────────────────────── */
.tourn-stack {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.tourn-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    padding: 24px;
}

.tourn-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 20px;
}

.tourn-title {
    font-size: 15px;
    font-weight: 600;
    color: #1e293b;
}

.tourn-subtitle {
    font-size: 12px;
    color: #64748b;
    margin-top: 3px;
}

/* ── Summary stats row ──────────────────────────────────────────────────── */
.summary-row {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
}

.summary-stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
    text-align: right;
}

.summary-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #94a3b8;
}

.summary-value {
    font-size: 22px;
    font-weight: 700;
    color: #1e293b;
    line-height: 1.1;
}

.summary-value sub {
    font-size: 11px;
    font-weight: 500;
    color: #64748b;
    vertical-align: baseline;
    margin-left: 3px;
}

/* ── Comparison table ───────────────────────────────────────────────────── */
.metric-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.metric-table thead th {
    padding: 10px 14px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    text-align: left;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    white-space: nowrap;
}

.metric-table thead th.th-num {
    text-align: right;
}

.metric-table thead th.th-sortable {
    cursor: pointer;
    user-select: none;
}

.metric-table thead th.th-sortable:hover {
    color: #334155;
    background: #f1f5f9;
}

.metric-table thead th.th-active {
    color: #5B21B6;
}

.sort-arrow {
    display: inline-block;
    margin-left: 3px;
    opacity: 0.45;
    font-style: normal;
    font-size: 10px;
}

.th-active .sort-arrow {
    opacity: 1;
}

.metric-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: background 0.1s;
}

.metric-table tbody tr:last-child {
    border-bottom: none;
}

.metric-table tbody tr:hover {
    background: #fafafa;
}

.metric-table tbody td {
    padding: 12px 14px;
    color: #334155;
    vertical-align: middle;
}

.metric-table td.td-num {
    text-align: right;
}

/* Best-value chip */
.cell-best {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 6px;
    background: #dcfce7;
    color: #15803d;
    font-weight: 700;
}

/* Rank column */
.td-rank {
    color: #94a3b8;
    font-size: 12px;
    font-weight: 600;
    width: 36px;
}

/* Model name + active badge */
.model-name {
    font-weight: 500;
    color: #1e293b;
}

.badge-active {
    display: inline-flex;
    align-items: center;
    padding: 2px 7px;
    border-radius: 9999px;
    background: #ede9fe;
    color: #5B21B6;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-left: 6px;
    vertical-align: middle;
}

/* Trained date */
.td-date {
    white-space: nowrap;
    color: #64748b;
    font-size: 12px;
}

/* Actions */
.action-btns {
    display: flex;
    gap: 6px;
    align-items: center;
}

.btn-load {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 5px 10px;
    border-radius: 7px;
    background: #5B21B6;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    font-family: inherit;
    text-decoration: none;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.15s;
}

.btn-load:hover {
    background: #4c1d95;
}

.btn-delete {
    display: inline-flex;
    align-items: center;
    padding: 5px 8px;
    border-radius: 7px;
    background: transparent;
    color: #ef4444;
    font-size: 11px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    border: 1.5px solid #fecaca;
    transition: background 0.15s, border-color 0.15s;
}

.btn-delete:hover {
    background: #fee2e2;
    border-color: #ef4444;
}

/* Empty-state (when all experiments deleted) */
.empty-state {
    padding: 48px 24px;
    text-align: center;
    color: #94a3b8;
    font-size: 13px;
}

/* ── Toast ──────────────────────────────────────────────────────────────── */
#toastMsg {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: rgba(15, 23, 42, 0.9);
    color: #f8fafc;
    border-radius: 10px;
    padding: 10px 18px;
    font-size: 13px;
    z-index: 9999;
    opacity: 0;
    transform: translateY(6px);
    pointer-events: none;
    transition: opacity 0.2s, transform 0.2s;
}

#toastMsg.visible {
    opacity: 1;
    transform: translateY(0);
}
</style>
{% endblock %}


{% block content %}
<div class="tourn-stack">

    <!-- ═══════════════════════════════════════════════════════════════════
         CARD 1 — AUC-ROC BAR CHART
         ═══════════════════════════════════════════════════════════════════ -->
    <div class="tourn-card">
        <div class="tourn-header">
            <div>
                <div class="tourn-title">AUC-ROC Comparison</div>
                <div class="tourn-subtitle">All saved experiments for {{ patient.id }}</div>
            </div>
            <div class="summary-row" id="summaryRow"></div>
        </div>

        <!-- SVG bar chart rendered by JS -->
        <div id="chartWrap" style="width:100%;"></div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════════════
         CARD 2 — SORTABLE LEADERBOARD TABLE
         ═══════════════════════════════════════════════════════════════════ -->
    <div class="tourn-card">
        <div class="tourn-header">
            <div>
                <div class="tourn-title">Experiment Leaderboard</div>
                <div class="tourn-subtitle">Click any metric column header to re-sort</div>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table class="metric-table" id="leaderTable" aria-label="Experiment leaderboard">
                <thead>
                    <tr>
                        <th class="td-rank">#</th>
                        <th>Model</th>
                        <th>Features</th>
                        <th class="th-sortable th-active th-num" data-col="auc"
                            onclick="sortBy('auc')">AUC-ROC <em class="sort-arrow">↓</em></th>
                        <th class="th-sortable th-num" data-col="precision"
                            onclick="sortBy('precision')">Precision <em class="sort-arrow">↕</em></th>
                        <th class="th-sortable th-num" data-col="recall"
                            onclick="sortBy('recall')">Recall <em class="sort-arrow">↕</em></th>
                        <th class="th-sortable th-num" data-col="f1"
                            onclick="sortBy('f1')">F1 <em class="sort-arrow">↕</em></th>
                        <th>Trained</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="leaderBody">
                    <!-- Rows rendered by JS -->
                </tbody>
            </table>
        </div>
    </div>

</div><!-- /.tourn-stack -->

<div id="toastMsg" role="status" aria-live="polite"></div>
{% endblock %}


{% block scripts %}
<script>
(function () {
    'use strict';

    const PATIENT_ID    = {{ patient.id | tojson }};
    const MODEL_LAB_URL = `/patient/${PATIENT_ID}/model-lab`;

    // ── Experiment data injected from Flask ──────────────────────────────────
    let experiments = {{ experiments | tojson }};

    // ── Sort state (default: AUC-ROC descending) ─────────────────────────────
    let sortState = { col: 'auc', dir: 'desc' };

    // ── Per-bar colors (match FEATURE_COLORS palette from app.py) ───────────
    const BAR_COLORS = ['#5B21B6', '#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444'];

    // Metric columns eligible for best-value highlighting
    const METRIC_COLS = ['auc', 'precision', 'recall', 'f1'];

    // ── Utility helpers ──────────────────────────────────────────────────────

    function fmt(v) {
        return (v != null) ? v.toFixed(2) : '—';
    }

    /** Return the maximum value across all remaining experiments for each metric col. */
    function bestValues() {
        const bests = {};
        METRIC_COLS.forEach(col => {
            bests[col] = Math.max(...experiments.map(e => e[col] ?? -Infinity));
        });
        return bests;
    }

    /** Return experiments sorted by sortState. */
    function sorted() {
        const col = sortState.col;
        const dir = sortState.dir === 'desc' ? -1 : 1;
        return [...experiments].sort((a, b) => dir * (b[col] - a[col]));
    }

    // ── AUC-ROC bar chart ────────────────────────────────────────────────────

    function drawChart() {
        const wrap = document.getElementById('chartWrap');
        if (!wrap) return;

        if (experiments.length === 0) {
            wrap.innerHTML = '<p class="empty-state">No experiments to compare.</p>';
            return;
        }

        const W      = wrap.clientWidth || 600;
        const H      = 180;
        const PAD    = { top: 38, right: 20, bottom: 52, left: 48 };
        const innerW = W - PAD.left - PAD.right;
        const innerH = H - PAD.top  - PAD.bottom;
        const n      = experiments.length;

        // Fixed bar width; centre each bar within its equal-width slot
        const slotW  = innerW / n;
        const barW   = Math.max(32, Math.min(72, slotW * 0.55));

        // Y-axis: 0 → 1.0
        const yScale = v => PAD.top + innerH * (1 - v);
        const bests  = bestValues();

        const parts = [];
        parts.push(`<svg width="${W}" height="${H}" style="display:block;overflow:visible;">`);

        // ── Y-axis grid lines (0.25 step) ────────────────────────────────────
        [0, 0.25, 0.5, 0.75, 1.0].forEach(t => {
            const y = yScale(t).toFixed(1);
            parts.push(`<line x1="${PAD.left}" y1="${y}" x2="${(PAD.left + innerW).toFixed(1)}" y2="${y}" stroke="${t === 0 ? '#e2e8f0' : '#f1f5f9'}" stroke-width="1"/>`);
            parts.push(`<text x="${PAD.left - 7}" y="${(+y + 3.5).toFixed(1)}" text-anchor="end" font-size="9" fill="#94a3b8" font-family="Inter,sans-serif">${t.toFixed(2)}</text>`);
        });

        // ── One bar per experiment (original declaration order) ───────────────
        experiments.forEach((exp, i) => {
            const cx     = PAD.left + i * slotW + slotW / 2;
            const barX   = (cx - barW / 2).toFixed(1);
            const barH   = (innerH * exp.auc).toFixed(1);
            const barY   = yScale(exp.auc).toFixed(1);
            const color  = BAR_COLORS[i % BAR_COLORS.length];
            const isBest = exp.auc === bests.auc;

            // Bar rectangle
            parts.push(`<rect x="${barX}" y="${barY}" width="${barW.toFixed(1)}" height="${barH}" rx="5" fill="${color}" opacity="${isBest ? '1' : '0.58'}"/>`);

            // Gold star above the best bar
            if (isBest) {
                parts.push(`<text x="${cx.toFixed(1)}" y="${(+barY - 20).toFixed(1)}" text-anchor="middle" font-size="16" font-family="Inter,sans-serif" fill="#f59e0b">★</text>`);
            }

            // AUC value label
            parts.push(`<text x="${cx.toFixed(1)}" y="${(+barY - 6).toFixed(1)}" text-anchor="middle" font-size="11" font-weight="600" fill="${color}" font-family="Inter,sans-serif">${exp.auc.toFixed(2)}</text>`);

            // Model name label below bar (truncated)
            const modelShort = exp.model.replace('Classifier', '').replace('Regressor', '').trim();
            parts.push(`<text x="${cx.toFixed(1)}" y="${(H - PAD.bottom + 16).toFixed(1)}" text-anchor="middle" font-size="11" fill="#475569" font-family="Inter,sans-serif">${modelShort}</text>`);
        });

        parts.push(`</svg>`);
        wrap.innerHTML = parts.join('\n');
    }

    // ── Summary stats ────────────────────────────────────────────────────────

    function renderSummary() {
        const row = document.getElementById('summaryRow');
        if (!row || experiments.length === 0) {
            if (row) row.innerHTML = '';
            return;
        }
        const bests   = bestValues();
        const bestExp = experiments.find(e => e.auc === bests.auc) || experiments[0];
        row.innerHTML = `
            <div class="summary-stat">
                <span class="summary-label">Experiments</span>
                <span class="summary-value">${experiments.length}<sub>runs</sub></span>
            </div>
            <div class="summary-stat">
                <span class="summary-label">Best AUC-ROC</span>
                <span class="summary-value">${bests.auc.toFixed(2)}<sub>${bestExp.model.split(' ')[0]}</sub></span>
            </div>
            <div class="summary-stat">
                <span class="summary-label">Best F1</span>
                <span class="summary-value">${bests.f1.toFixed(2)}</span>
            </div>
        `;
    }

    // ── Table renderer ───────────────────────────────────────────────────────

    function renderTable() {
        const tbody = document.getElementById('leaderBody');
        if (!tbody) return;

        if (experiments.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state">All experiments deleted. Run a new experiment in Model Lab.</div></td></tr>`;
            updateSortHeaders();
            return;
        }

        const rows  = sorted();
        const bests = bestValues();

        /** Wrap value in best chip if it equals the column maximum. */
        function metricCell(exp, col) {
            const v      = exp[col];
            const isBest = v === bests[col];
            const label  = fmt(v);
            return isBest
                ? `<td class="td-num"><span class="cell-best">${label}</span></td>`
                : `<td class="td-num">${label}</td>`;
        }

        tbody.innerHTML = rows.map((exp, rank) => `
            <tr data-id="${exp.id}">
                <td class="td-rank">${rank + 1}</td>
                <td>
                    <span class="model-name">${exp.model}</span>
                    ${exp.is_current ? '<span class="badge-active">Active</span>' : ''}
                </td>
                <td>${exp.features}</td>
                ${metricCell(exp, 'auc')}
                ${metricCell(exp, 'precision')}
                ${metricCell(exp, 'recall')}
                ${metricCell(exp, 'f1')}
                <td class="td-date">${exp.trained}</td>
                <td>
                    <div class="action-btns">
                        <a class="btn-load" href="${MODEL_LAB_URL}"
                           title="Open Model Lab with this experiment's configuration"
                           aria-label="Load experiment ${exp.id} into Model Lab">
                            <!-- external-link icon -->
                            <svg width="11" height="11" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2.5"
                                 stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                            Load
                        </a>
                        <button class="btn-delete"
                                onclick="deleteExp(${exp.id})"
                                title="Remove experiment from list"
                                aria-label="Delete experiment ${exp.id}">
                            <!-- trash icon -->
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2.5"
                                 stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                                <path d="M10 11v6"/><path d="M14 11v6"/>
                                <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        updateSortHeaders();
    }

    // ── Column header sort indicators ────────────────────────────────────────

    function updateSortHeaders() {
        document.querySelectorAll('.th-sortable').forEach(th => {
            const col   = th.dataset.col;
            const arrow = th.querySelector('.sort-arrow');
            const active = col === sortState.col;
            th.classList.toggle('th-active', active);
            if (arrow) {
                arrow.textContent = !active ? '↕' : (sortState.dir === 'desc' ? '↓' : '↑');
            }
        });
    }

    // ── Sort handler ─────────────────────────────────────────────────────────

    function sortBy(col) {
        if (sortState.col === col) {
            // Toggle direction on same column
            sortState.dir = sortState.dir === 'desc' ? 'asc' : 'desc';
        } else {
            sortState.col = col;
            sortState.dir = 'desc';  // always start descending on new column
        }
        renderTable();
    }

    // ── Delete handler ───────────────────────────────────────────────────────

    function deleteExp(id) {
        experiments = experiments.filter(e => e.id !== id);
        renderTable();
        drawChart();
        renderSummary();
        showToast('Experiment removed (session only — not persisted to server).');
    }

    // ── Toast notification ───────────────────────────────────────────────────

    function showToast(msg) {
        const el = document.getElementById('toastMsg');
        if (!el) return;
        el.textContent = msg;
        el.classList.add('visible');
        setTimeout(() => el.classList.remove('visible'), 3500);
    }

    // ── Expose callbacks to inline event handlers ────────────────────────────
    window.sortBy    = sortBy;
    window.deleteExp = deleteExp;

    // ── Initial render ───────────────────────────────────────────────────────
    renderSummary();
    drawChart();
    renderTable();

    // Redraw bar chart on resize
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(drawChart, 80);
    });
})();
</script>
{% endblock %}
